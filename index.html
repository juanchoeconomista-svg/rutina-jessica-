<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#4f46e5">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./style.css">
  <title>Rutina Jessica</title>
</head>
<body>
  <header>
    <h1>Rutina Semanal</h1>
    <button id="resetBtn">Reiniciar</button>
  </header>
  <section class="section">
    <h2 id="weekInfo">Semana 1 - Peso sugerido: 20kg</h2>
    <div class="calendar" id="calendar"></div>
    <label>Progreso: <span id="progressText">0%</span></label>
    <progress id="progressBar" value="0" max="100"></progress>
  </section>
  <div id="app"></div>
  <script>
    const START_WEIGHT = 20;
    const INCREMENT_PER_WEEK = 5;
    const TOTAL_WEEKS = 24;

    const routine = {
      "Lunes": ["Press de pecho (3x12)", "Elevaciones laterales (2x15)", "Fondos en banco (2x12)", "Plancha abdominal (3x30s)", "Vóley"],
      "Martes": ["Sentadilla libre (3x12)", "Peso muerto rumano (3x15)", "Hip thrust (2x15)", "Crunch (3x15)", "Stretching", "Yoga"],
      "Miércoles": ["Circuito funcional (2 rondas)", "Plancha lateral (2x20s)", "Calistenia", "Vóley"],
      "Jueves": ["Jalón al pecho (3x12)", "Remo mancuerna (3x12)", "Curl bíceps (2x15)", "Elevaciones piernas (3x12)", "Stretching", "Yoga"],
      "Viernes": ["Prensa (3x15)", "Curl femoral (3x12)", "Abducción cadera (2x15)", "Pallof press (2x12)", "Vóley"],
      "Sábado": ["Sentadilla goblet (2x15)", "Press hombros (2x15)", "Face-pull (2x15)", "Plancha lateral + rotación (2x10)", "Movilidad"],
      "Domingo": ["Cardio suave (30 min)", "Estiramientos"]
    };

    const STORAGE_KEY = 'rutinaChecked';
    const START_KEY = 'rutinaStart';

    function getChecked() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    }
    function setChecked(obj) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    }

    function calculateWeekAndWeight() {
      let start = localStorage.getItem(START_KEY);
      if (!start) {
        start = new Date().toISOString();
        localStorage.setItem(START_KEY, start);
      }
      const startDate = new Date(start);
      const now = new Date();
      const diffMs = now - startDate;
      const diffWeeks = Math.floor(diffMs / (1000 * 60 * 60 * 24 * 7)) + 1;
      const wk = Math.min(diffWeeks, TOTAL_WEEKS);
      const wt = START_WEIGHT + (wk - 1) * INCREMENT_PER_WEEK;
      return { wk, wt };
    }

    function buildCalendar(currentWeek) {
      const cal = document.getElementById('calendar');
      cal.innerHTML = '';
      for (let i = 1; i <= TOTAL_WEEKS; i++) {
        const div = document.createElement('div');
        div.innerHTML = '<strong>S' + i + '</strong><br>' + (START_WEIGHT + (i-1)*INCREMENT_PER_WEEK) + 'kg';
        if (i === currentWeek) div.classList.add('current');
        cal.appendChild(div);
      }
    }

    function updateProgress() {
      const checked = getChecked();
      const total = Object.values(routine).flat().length;
      const done = Object.values(checked).filter(v => v).length;
      const percent = Math.round((done/total)*100);
      document.getElementById('progressText').innerText = percent + '%';
      document.getElementById('progressBar').value = percent;
    }

    function buildApp() {
      const app = document.getElementById('app');
      const checked = getChecked();
      Object.keys(routine).forEach(day => {
        const sec = document.createElement('section');
        sec.className = 'section';
        const h2 = document.createElement('h2');
        h2.innerText = day;
        sec.appendChild(h2);
        const ul = document.createElement('ul');
        routine[day].forEach((item, idx) => {
          const li = document.createElement('li');
          const key = day + '-' + idx;
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = checked[key] || false;
          cb.onchange = () => {
            checked[key] = cb.checked;
            setChecked(checked);
            updateProgress();
          };
          const span = document.createElement('span');
          span.style.marginLeft = '8px';
          span.innerText = item;
          li.appendChild(cb);
          li.appendChild(span);
          ul.appendChild(li);
        });
        sec.appendChild(ul);
        app.appendChild(sec);
      });
      updateProgress();
    }

    document.getElementById('resetBtn').onclick = () => {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(START_KEY);
      location.reload();
    };

    window.addEventListener('load', () => {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js');
      }
      const { wk, wt } = calculateWeekAndWeight();
      document.getElementById('weekInfo').innerText = 'Semana ' + wk + ' - Peso sugerido: ' + wt + 'kg';
      buildCalendar(wk);
      buildApp();
    });
  </script>
</body>
</html>
